require("dotenv").config({ override: true });

const express = require("express");
const cors = require("cors");
const rateLimit = require("express-rate-limit");
const fs = require("fs");
const path = require("path");

const chatRoutes = require("./routes/chat.routes");
const whatsappWebhook = require("./routes/whatsappWebhook");

const app = express();
app.set("trust proxy", 1); // Nginx/Proxy

// DomÃ­nios permitidos (CORS)
const ALLOWED_ORIGINS = [
  "https://dcinfinity.net.br",
  "https://www.dcinfinity.net.br",
];

// WhatsApp oficial (use o mesmo do site)
const WHATSAPP_OFICIAL = process.env.WHATSAPP_OFICIAL || "5561991374910";

// HorÃ¡rio de atendimento (padrÃ£o)
const BUSINESS_HOURS = {
  tz: "America/Sao_Paulo",
  days: ["mon", "tue", "wed", "thu", "fri", "sat"],
  start: "08:00",
  end: "18:00",
};

// Arquivo de leads
const DATA_FILE = path.resolve(__dirname, "..", "data", "leads.json");

// ===============================
// MIDDLEWARES
// ===============================
app.use(express.json({ limit: "250kb" }));

app.use(
  cors({
    origin: function (origin, cb) {
      // permite curl/postman (sem origin)
      if (!origin) return cb(null, true);
      if (ALLOWED_ORIGINS.includes(origin)) return cb(null, true);
      return cb(new Error("Not allowed by CORS"));
    },
    credentials: true,
  })
);

// Rate limit (anti-spam)
app.use(
  rateLimit({
    windowMs: 60 * 1000, // 1 min
    max: 40, // 40 req/min por IP
    standardHeaders: true,
    legacyHeaders: false,
  })
);

// ===============================
// HELPERS
// ===============================
function onlyDigits(str) {
  return (str || "").replace(/\D/g, "");
}

function normalizeText(str) {
  return (str || "")
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .trim();
}

function safeReadJsonArray(filePath) {
  try {
    if (!fs.existsSync(filePath)) return [];
    const raw = fs.readFileSync(filePath, "utf8");
    const data = JSON.parse(raw || "[]");
    return Array.isArray(data) ? data : [];
  } catch {
    return [];
  }
}

function safeWriteJsonArray(filePath, arr) {
  fs.writeFileSync(filePath, JSON.stringify(arr, null, 2), "utf8");
}

function nowInSaoPaulo() {
  const parts = new Intl.DateTimeFormat("pt-BR", {
    timeZone: BUSINESS_HOURS.tz,
    hour: "2-digit",
    minute: "2-digit",
    hour12: false,
    weekday: "short",
  }).formatToParts(new Date());

  const get = (type) => parts.find((p) => p.type === type)?.value;

  const hour = get("hour") || "00";
  const minute = get("minute") || "00";

  // weekday vem tipo: "seg.", "ter.", ...
  const weekdayRaw = normalizeText(get("weekday") || "seg.");
  const map = {
    "seg.": "mon",
    "ter.": "tue",
    "qua.": "wed",
    "qui.": "thu",
    "sex.": "fri",
    "sab.": "sat",
    "dom.": "sun",
  };
  const day = map[weekdayRaw] || "mon";

  return { day, time: `${hour}:${minute}` };
}

function isWithinBusinessHours() {
  const { day, time } = nowInSaoPaulo();
  if (!BUSINESS_HOURS.days.includes(day)) return false;
  return time >= BUSINESS_HOURS.start && time <= BUSINESS_HOURS.end;
}

function waLink(prefillText) {
  return `https://wa.me/${WHATSAPP_OFICIAL}?text=${encodeURIComponent(
    prefillText || ""
  )}`;
}

// ===============================
// INTENTS
// ===============================
function detectIntent(message) {
  const t = normalizeText(message);

  const wantsPlans = /(plano|planos|preco|valor|mensalidade|internet|mega|mbps)/.test(t);
  const wantsSupport = /(suporte|sem internet|lento|queda|caiu|roteador|onu|olt|wifi|sinal|problema)/.test(t);
  const wantsSales = /(assinar|contratar|instalar|instalacao|comercial|quero internet|quero plano|vendas|orcamento)/.test(t);
  const wantsHuman = /(atendente|humano|pessoa|falar com alguem|whatsapp|chamar no whats|telefone)/.test(t);

  if (wantsHuman) return "human";
  if (wantsSupport) return "support";
  if (wantsSales) return "sales";
  if (wantsPlans) return "plans";
  return "unknown";
}

function msgPlans() {
  return [
    "ðŸ“¦ *Planos DCNET Infinity (Planaltina-DF)*",
    "",
    "âœ… 350 Mbps â€“ *R$ 78,99*",
    "âœ… 400 Mbps â€“ *R$ 88,99*",
    "âœ… 500 Mbps â€“ *R$ 98,99*",
    "âœ… 600 Mbps â€“ *R$ 119,99*",
    "",
    "Pra eu te orientar melhor:",
    "1) Qual seu *bairro*?",
    "2) Uso principal: *Casa / Trabalho / Jogos / Streaming*?",
  ].join("\n");
}

function msgSupport() {
  return [
    "ðŸ› ï¸ *Suporte tÃ©cnico DCNET Infinity*",
    "",
    "Me passe por favor:",
    "1) *CPF do titular* (pode ser parcial)",
    "2) *WhatsApp* para retorno",
    "3) O problema: *sem internet / lento / quedas / wifi*",
    "",
    "Se preferir atendimento humano, digite: *ATENDENTE*",
  ].join("\n");
}

function msgSales() {
  return [
    "ðŸ’° *Comercial DCNET Infinity*",
    "",
    "Perfeito! Vou te ajudar com a contrataÃ§Ã£o.",
    "Me envie:",
    "1) *Nome*",
    "2) *WhatsApp*",
    "3) *Bairro/Rua*",
    "4) Plano desejado (*350/400/500/600*)",
    "",
    "Se quiser falar direto com atendente, digite: *ATENDENTE*",
  ].join("\n");
}

function msgHuman() {
  const online = isWithinBusinessHours();
  const prefill =
    "OlÃ¡! Vim pelo site da DCNET Infinity e quero falar com um atendente. Pode me ajudar?";

  return [
    "ðŸ‘¨â€ðŸ’» *Atendimento humano DCNET Infinity*",
    online
      ? "âœ… Estamos *dentro do horÃ¡rio de atendimento*."
      : "â° Estamos *fora do horÃ¡rio agora*, mas pode mandar a mensagem que retornamos.",
    "",
    "Clique para chamar no WhatsApp (mensagem pronta):",
    waLink(prefill),
  ].join("\n");
}

function msgDefault() {
  return [
    "ðŸ‘‹ OlÃ¡! Eu sou o assistente da *DCNET Infinity*.",
    "",
    "Como posso te ajudar agora?",
    "1) Digite *PLANOS* para ver os valores",
    "2) Digite *SUPORTE* se estiver com problema",
    "3) Digite *COMERCIAL* para contratar",
    "4) Digite *ATENDENTE* para falar com humano",
  ].join("\n");
}

// ===============================
// LEADS
// ===============================
function saveLead({ name, phone, intent, plan, neighborhood, message }) {
  const leads = safeReadJsonArray(DATA_FILE);

  const payload = {
    id: `${Date.now()}-${Math.floor(Math.random() * 1000)}`,
    createdAt: new Date().toISOString(),
    name: (name || "").trim(),
    phone: onlyDigits(phone || ""),
    intent: intent || "unknown",
    plan: (plan || "").trim(),
    neighborhood: (neighborhood || "").trim(),
    message: (message || "").trim(),
  };

  leads.push(payload);
  safeWriteJsonArray(DATA_FILE, leads);
  return payload;
}

// ===============================
// ROUTES
// ===============================
app.get("/health", (req, res) => {
  res.json({ ok: true, service: "chatbot-dcinfinity" });
});

// ===============================
// ROUTES
// ===============================
app.get("/health", (req, res) => {
  res.json({ ok: true, service: "chatbot-dcinfinity" });
});

// Webhook do WhatsApp (mantÃ©m)
app.use(whatsappWebhook); // deve expor /webhook/whatsapp

// API do chat (usa src/routes/chat.routes.js -> POST /api/chat)
app.use("/api", chatRoutes);

    // Campos opcionais (para lead)
    const name = (req.body?.name || "").toString();
    const phone = (req.body?.phone || "").toString();
    app.get("/health", (req, res) => {
  res.json({ ok: true, service: "chatbot-dcinfinity" });
});

app.use(whatsappWebhook); // âœ… /webhook/whatsapp
app.use("/api", chatRoutes);

module.exports = app;
